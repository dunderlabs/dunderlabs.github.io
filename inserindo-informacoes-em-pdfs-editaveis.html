<!doctype html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
    <meta name="description" content="
    4 amigos com gostos igualmente parecidos e diferentes, reunindo
    conhecimento, experiências e muitas dúvidas sobre: Front-End,
    Python/Django, Linux, JS e etc. Devolvemos à comunidade o que em muitos
    momentos ela nos ofereceu.
">
    <meta name="keywords" content="pug-pi, python, parnaiba, desenvolvimento, web, django"/>
    <meta name="generator" content="Feito com Pure, Pelican, Python e Sublime. ">

    <!-- OpenGraph -->
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Inserindo informações em PDFs editáveis com Python"/>
    <meta property="og:url" content="https://dunderlabs.github.io/inserindo-informacoes-em-pdfs-editaveis.html"/>
    <meta property="og:site_name" content="__labs__"/>
    <meta property="og:description" content="É muito comum no mercado o uso de arquivos editáveis para gerar relatórios, como arquivos .xls. Mas e PDF? Precisei fazer isso no trabalho e quero..."/>
    <meta property="og:image" content="https://dunderlabs.github.io/images/posts/python-pdf.jpg"/>

    <!-- Twitter -->
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:site" content="@dunderlabs"/>
    <meta name="twitter:creator" content="@ericleribertson"/>
    <meta name="twitter:domain" content="dunderlabs.github.io"/>
    <meta name="twitter:title" content="Inserindo informações em PDFs editáveis com Python"/>
    <meta name="twitter:description" content="É muito comum no mercado o uso de arquivos editáveis para gerar relatórios, como arquivos .xls. Mas e PDF? Precisei fazer isso no trabalho e quero..."/>
    <meta name="twitter:image:src" content="https://dunderlabs.github.io/images/posts/python-pdf.jpg"/>

    <!-- Article meta -->
    <meta property="article:author" content="Patrick Mazulo"/>
    <meta property="article:section" content="python"/>
    <meta property="article:tag" content="python, pdf"/>
    <meta property="article:published_time" content="2020-05-31T10:56:00-03:00"/>

    <!-- Google+ -->
    <meta itemprop="name" content="Inserindo informações em PDFs editáveis com Python"/>
    <meta itemprop="description" content="É muito comum no mercado o uso de arquivos editáveis para gerar relatórios, como arquivos .xls. Mas e PDF? Precisei fazer isso no trabalho e quero..."/>
    <meta itemprop="image" content="https://dunderlabs.github.io/images/posts/python-pdf.jpg"/>

    <!-- General purpose meta -->
    <meta name="description" content="É muito comum no mercado o uso de arquivos editáveis para gerar relatórios, como arquivos .xls. Mas e PDF? Precisei fazer isso no trabalho e quero..."/>
    <meta name="keywords" content="python, pdf"/>

    <!-- FEED STUFFS  -->
        <link rel="alternate"  href="https://dunderlabs.github.io/feeds/all.atom.xml" type="application/atom+xml" title="__labs__ Full Atom Feed"/>
    <!-- END FEED STUFFS  -->

        <title>Inserindo informações em PDFs editáveis com Python // __labs__</title>


    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://dunderlabs.github.io/theme/css/pure.css">
    <link rel="stylesheet" href="https://dunderlabs.github.io/theme/css/pygments.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <a href="https://dunderlabs.github.io/author/patrick-mazulo.html" title="See posts by Patrick Mazulo">
                        <img class="avatar" alt="Patrick Mazulo" src="https://www.gravatar.com/avatar/47e5c8ea3ee6a7d796129b4f7e00afb9">
                </a>
                <h2 class="article-info">Patrick Mazulo</h2>
                <small class="about-author">My name is Patrick and I'm a web developer who fell in love with Python</small>
                <h5>Publicado</h5>
                <p>31/05/2020</p>
                <a href="/">&larr; Home</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Inserindo informações em PDFs editáveis com Python</h1>
                        <p class="post-meta">
                            // tags                                 <a class="post-category" href="https://dunderlabs.github.io/tag/python.html">python</a>
                                <a class="post-category" href="https://dunderlabs.github.io/tag/pdf.html">pdf</a>
                        </p>
                </header>
            </section>
            <p><img alt="Python + PDF" src="https://dunderlabs.github.io/images/posts/python-pdf.jpg" /></p>
<p>Créditos da imagem: <a href="https://pdftables.com/blog/pdf-to-excel-with-python">https://pdftables.com/blog/pdf-to-excel-with-python</a></p>
<p>Fala pessoal, tudo beleza? Quase 3 anos depois, estou de volta ao blog. E dessa vez, para ficar!</p>
<p><img alt="I am back" src="https://media.giphy.com/media/yj5UdA4elp8Wc/giphy.gif" /></p>
<h1>Como começou</h1>
<p>Há algum tempo que eu estava pensando em algum assunto interessante para voltar a escrever aqui. Algo pequeno porém conciso. Daí, em um dia normal do trabalho, passei muita dor de cabeça pra resolver um problema.</p>
<p>Era um projeto que um colega me propôs onde iríamos melhorar um processo para os nossos usários internos. Atualmente, pra finalizar esse processo, nossos usuários faziam o seguinte:</p>
<ul>
<li>Baixavam um template de PDF</li>
<li>Buscavam no sistema as informações necessárias para preenchê-lo</li>
<li>Preenchiam manualmente</li>
<li>Exportavam o template como um novo PDF (para que fosse read-only)</li>
<li>Checavam novamente se todas as informações estava corretas</li>
</ul>
<p>Acho que já deu pra visualizar onde o gargalo e consumo de tempo estão, né? Pois é. Para resolver isso, a proposta seria: inserir essas informações no template de PDF automáticamente com os dados que já tínhamos no banco de dados... Na primeira vez que ele me falou isso, minha reação imediata foi:</p>
<p><img alt="Como???" src="https://media.giphy.com/media/QjIz1AqkGTszK/giphy.gif" /></p>
<h1>A busca pela lib (quase) perfeita</h1>
<p>É bem comum manipulações com certos tipos de arquivo, como <code>.csv</code> ou mesmo arquivos <code>.xlsx</code>. Apesar de eu saber que não é impossível fazer o mesmo com PDF, pelo pouco que eu sabia do arquivo, seria bem trabalhoso (spoiler: nem foi tanto assim).</p>
<p>Certo, se é isso que precisamos fazer, vamos nessa. Comecei a pesquisar sobre maneiras de manipular arquivos PDF. Uma amiga do trabalho também me enviou dois links (<a href="https://medium.com/@umerfarooq_26378/python-for-pdf-ef0fac2808b0">PDF for Python</a> e <a href="https://towardsdatascience.com/pdf-preprocessing-with-python-19829752af9f">PDF processing with Python</a>) que ajudaram bastante.</p>
<p>Neles temos listados algumas libs Python já existentes para lidar com esse tipo de arquivo. Tem algumas que parece ser bem famosas nesse quesito. Uma entre elas me chamou atenção. E essa foi a <a href="https://github.com/pmaupin/pdfrw"><code>pdfrw</code></a>, por ter o seguinte na descrição: <em>The <strong>fastest</strong> pure Python PDF parser available</em>.</p>
<p>A <a href="https://github.com/mstamy2/PyPDF2">PyPDF2</a> também carrega essa alcunha no título, com exceção do <em>fastest</em>. Não fiz nenhum teste de benchmarch (ainda), então preferi acreditar na audácia do autor em colocar isso :P</p>
<p>Biblioteca escolhida, vem a segunda parte: como fazer para preencher um template de PDF com as informações que nós queremos? Bom, de volta a sala de pesquisa. Adentrando um pouco mais o Google, consegui encontrar um post de alguém que ensinava como fazer <strong>exatamente</strong> o que eu precisava: <a href="https://bostata.com/how-to-populate-fillable-pdfs-with-python/"><em>How to Populate Fillable PDF's with Python</em></a>.</p>
<p>Achei uma abordagem muito simples, além de ter me lembrado de algo que eu já não fazia há algum tempo: salvar e compartilhar um aprendizado (o autor do post antes de chegar nessa solução, também pesquisou bastante e se baseou em outros posts). Beleza, vamos colocar os dedos no código!</p>
<h1>Preparando as ferramentas</h1>
<p>Mas antes de qualquer código, precisamos preparar nosso template de PDF. Assim como no post mencionado anteriormente, vamos pegar um do <a href="https://squareup.com/us/en/invoices/invoice-templates">Square</a>, onde podemos baixar um PDf de <a href="https://d1g145x70srn7h.cloudfront.net/invoices/templates/red/invoice-template-en-us.pdf?color=red&amp;format=pdf">cobrança gratuitamente</a>. Primeiro, vamos abrir esse arquivo para ver o que temos. Estou usando KDE, então estou utilizando o Okular para arquivos PDF. Ao abrir o arquivo, essa é a imagem que tenho:</p>
<p><img alt="PDF aberto usando Okular" src="https://i.imgur.com/d2icDUe.png" />.</p>
<p>Você vai notar que tem um botão <em>Show Forms</em> e ao clicar nele caixas escuras vão aparecer no PDF onde existem campos preenchíveis (você pode checar <a href="https://i.imgur.com/1vdbroU.png">aqui</a>). Cada campo desse pode ter um valor inserido. É realmente como se fosse um formulário.</p>
<p>Certo, agora o próximo passo é editar o <em>nome</em> de cada um desses campos pra algo mais próximo do nome de uma variável, afinal seria um pouco estranho ficar referenciando <code>Business Name</code> ao invés de <code>business_name</code> (vamos ver como isso vai ajudar mais na frente).</p>
<p>Para isso, vamos precisar de algum programa para editar esse form, e infelizmente o Okular não tem essa funcionalidade. Pesquisando um pouco encontrei algumas opções e para fins de praticidade acabei ficando com o <a href="https://aur.archlinux.org/packages/masterpdfeditor-free/">Master PDF Editor Free</a>. É a versão free de um software pago. Também encontrei uma ferramenta web que nos traz a mesma funcionalidade, <a href="https://www.pdfescape.com/">PDF Escape</a>.</p>
<p>Só fica um pouco escondida (você tem que dar <a href="https://i.imgur.com/mTcFDRy.png"><em>unlock</em></a> no field, depois <a href="https://i.imgur.com/8LAUe1o.png"><em>Object Properties</em></a> que vai abrir um <a href="https://i.imgur.com/NsxzsfE.png"><em>modal</em></a> onde você vai poder mudar o <code>Name</code> do field). Finalizando toda a troca dos nomes por um snake-case, teremos o seguinte:</p>
<p><img alt="PDF com nomes em snake-case" src="https://i.imgur.com/dnzC6hm.png" /></p>
<h1>Agora sim, código!</h1>
<p>Agora vamos pegar cada um desses nomes e salvar em um dicionário sendo as chaves e criar alguns valores fictícios. Aqui vou deixar ele assim:</p>
<div class="highlight"><pre><span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s">&#39;business_email_address&#39;</span><span class="p">:</span> <span class="s">&#39;contato@dunderlabs.com&#39;</span><span class="p">,</span>
   <span class="s">&#39;business_name_1&#39;</span><span class="p">:</span> <span class="s">&#39;Dunderlabs&#39;</span><span class="p">,</span>
   <span class="s">&#39;business_name_2&#39;</span><span class="p">:</span> <span class="s">&#39;Dunderlabs&#39;</span><span class="p">,</span>
   <span class="s">&#39;business_phone_number&#39;</span><span class="p">:</span> <span class="s">&#39;(34) 2222-2222&#39;</span><span class="p">,</span>
   <span class="s">&#39;customer_email&#39;</span><span class="p">:</span> <span class="s">&#39;mazulo@dunderlabs.com&#39;</span><span class="p">,</span>
   <span class="s">&#39;customer_name&#39;</span><span class="p">:</span> <span class="s">&#39;Patrick Mazulo&#39;</span><span class="p">,</span>
   <span class="s">&#39;due_date&#39;</span><span class="p">:</span> <span class="s">&#39;30/05/2020&#39;</span><span class="p">,</span>
   <span class="s">&#39;invoice_number&#39;</span><span class="p">:</span> <span class="s">&#39;5786878&#39;</span><span class="p">,</span>
   <span class="s">&#39;item_1_amount&#39;</span><span class="p">:</span> <span class="s">&#39;R$8000&#39;</span><span class="p">,</span>
   <span class="s">&#39;item_1_price&#39;</span><span class="p">:</span> <span class="s">&#39;R$200/hr&#39;</span><span class="p">,</span>
   <span class="s">&#39;item_1_quantity&#39;</span><span class="p">:</span> <span class="s">&#39;40 hours&#39;</span><span class="p">,</span>
   <span class="s">&#39;item_1&#39;</span><span class="p">:</span> <span class="s">&#39;Criação de blog&#39;</span><span class="p">,</span>
   <span class="s">&#39;note_contents&#39;</span><span class="p">:</span> <span class="s">&#39;Muito obrigado por realizar essa compra!&#39;</span><span class="p">,</span>
   <span class="s">&#39;send_date&#39;</span><span class="p">:</span> <span class="s">&#39;29/05/2020&#39;</span><span class="p">,</span>
   <span class="s">&#39;subtotal&#39;</span><span class="p">:</span> <span class="s">&#39;R$8000&#39;</span><span class="p">,</span>
   <span class="s">&#39;total&#39;</span><span class="p">:</span> <span class="s">&#39;R$8000&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>Um arquivo de PDF internamente parece ter algumas peculiaridades interessantes em relação a como é construído e interpretado. Vale a pena dar uma lida maior sobre o tipo de arquivo se bater uma curiosidade maior (a especificação do arquivo tem mais de 1000 páginas!).</p>
<p>Agora, vamos começar a brincar com o PDF usando pdfrw. Primeiramente, precisamos instalar a lib usando nosso clássico <code>pip install pdfrw</code>. Agora vou abrir um terminal do ipython para que possamos ver o que temos:</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">pdfrw</span> <span class="kn">import</span> <span class="n">PdfReader</span>                                                    

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">os</span>                                                                      

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>                                                       

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;Documents/Dunderlabs/Posts/pdf_template.pdf&#39;</span>                           

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">pdf</span> <span class="o">=</span> <span class="n">PdfReader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">(),</span> <span class="n">path</span><span class="p">))</span>                               

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="n">pdf</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>                                                                     
<span class="n">Out</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="p">[</span><span class="s">&#39;/Root&#39;</span><span class="p">,</span> <span class="s">&#39;/Info&#39;</span><span class="p">,</span> <span class="s">&#39;/ID&#39;</span><span class="p">,</span> <span class="s">&#39;/Size&#39;</span><span class="p">]</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="n">pdf</span><span class="o">.</span><span class="n">Info</span>                                                                       
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]:</span> 
<span class="p">{</span><span class="s">&#39;/CreationDate&#39;</span><span class="p">:</span> <span class="s">&#39;(D:20160817230153Z)&#39;</span><span class="p">,</span>
 <span class="s">&#39;/Creator&#39;</span><span class="p">:</span> <span class="s">&#39;(Word)&#39;</span><span class="p">,</span>
 <span class="s">&#39;/Keywords&#39;</span><span class="p">:</span> <span class="s">&#39;()&#39;</span><span class="p">,</span>
 <span class="s">&#39;/ModDate&#39;</span><span class="p">:</span> <span class="s">&quot;(D:20160902175952-07&#39;00&#39;)&quot;</span><span class="p">,</span>
 <span class="s">&#39;/Producer&#39;</span><span class="p">:</span> <span class="s">&#39;(Adobe Mac PDF Plug-in)&#39;</span><span class="p">,</span>
 <span class="s">&#39;/Title&#39;</span><span class="p">:</span> <span class="s">&#39;(Microsoft Word - [For PDF] Invoice Template - Purple.dotx)&#39;</span><span class="p">}</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>                                                                 
<span class="n">Out</span><span class="p">[</span><span class="mi">8</span><span class="p">]:</span> <span class="mi">1</span>
</pre></div>


<p>Como podemos ver, o <code>PdfReader</code> lê o arquivo PDF e entrega pra gente um objeto de fácil interação. Pelo que pudemos ver, essa instância também tem métodos que você normalmente encontra em um dicionário, como <code>.keys()</code>.</p>
<p>Se você der um <code>dir(pdf)</code> vai conseguir ver todos os métodos que esse objeto nos dá, entre eles <code>.values()</code>, <code>.update()</code> (métodos de <code>dict</code>) além de métodos da específicos da classe <code>PdfReader</code>. Se você der um print em <code>pdf.Root</code> ele irá mostrar todo o conteúdo do PDF parseado na estrutura <code>key:value</code> que a lib cria.</p>
<p>O código que vamos usar para escrever as nossas informações no template, vai percorrer a estrutura da página do template (no nosso caso, só temos 1 página) usando essas "notações" para chegar nos campos editáveis. Para concluir nosso objetivo, vamos ter o seguinte código:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">pdfrw</span>


<span class="n">TEMPLATE_PATH</span> <span class="o">=</span> <span class="s">&#39;Documents/Dunderlabs/Posts/pdf_template.pdf&#39;</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="s">&#39;Documents/Dunderlabs/Posts/invoice.pdf&#39;</span>

<span class="n">ANNOT_KEY</span> <span class="o">=</span> <span class="s">&#39;/Annots&#39;</span>
<span class="n">ANNOT_FIELD_KEY</span> <span class="o">=</span> <span class="s">&#39;/T&#39;</span>
<span class="n">SUBTYPE_KEY</span> <span class="o">=</span> <span class="s">&#39;/Subtype&#39;</span>
<span class="n">WIDGET_SUBTYPE_KEY</span> <span class="o">=</span> <span class="s">&#39;/Widget&#39;</span>


<span class="k">def</span> <span class="nf">write_pdf</span><span class="p">(</span><span class="n">input_pdf</span><span class="p">,</span> <span class="n">output_pdf</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
    <span class="n">template_pdf</span> <span class="o">=</span> <span class="n">pdfrw</span><span class="o">.</span><span class="n">PdfReader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">(),</span> <span class="n">input_pdf</span><span class="p">))</span>  <span class="c"># [1]</span>

    <span class="n">annotations</span> <span class="o">=</span> <span class="n">template_pdf</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ANNOT_KEY</span><span class="p">]</span>  <span class="c"># [2]</span>

    <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>  <span class="c"># [3]</span>
        <span class="k">if</span> <span class="n">annotation</span><span class="p">[</span><span class="n">SUBTYPE_KEY</span><span class="p">]</span> <span class="o">==</span> <span class="n">WIDGET_SUBTYPE_KEY</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">annotation</span><span class="p">[</span><span class="n">ANNOT_FIELD_KEY</span><span class="p">]:</span>  <span class="c"># [4]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="n">ANNOT_FIELD_KEY</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c"># [5]</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c"># [6]</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s">&#39;V&#39;</span><span class="p">:</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>  <span class="c"># [7]</span>
                    <span class="p">}</span>
                    <span class="n">annotation</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pdfrw</span><span class="o">.</span><span class="n">PdfDict</span><span class="p">(</span><span class="o">**</span><span class="n">update</span><span class="p">))</span>  <span class="c"># [8]</span>
        <span class="n">annotation</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pdfrw</span><span class="o">.</span><span class="n">PdfDict</span><span class="p">(</span><span class="n">Ff</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>  <span class="c"># [9]</span>

    <span class="n">template_pdf</span><span class="o">.</span><span class="n">Root</span><span class="o">.</span><span class="n">AcroForm</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>  <span class="c"># [10]</span>
        <span class="n">pdfrw</span><span class="o">.</span><span class="n">PdfDict</span><span class="p">(</span><span class="n">NeedAppearances</span><span class="o">=</span><span class="n">pdfrw</span><span class="o">.</span><span class="n">PdfObject</span><span class="p">(</span><span class="s">&#39;true&#39;</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">pdfrw</span><span class="o">.</span><span class="n">PdfWriter</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">(),</span> <span class="n">output_pdf</span><span class="p">),</span> <span class="n">template_pdf</span><span class="p">)</span>  <span class="c"># [11]</span>
</pre></div>


<p>Agora vamos comentar as partes mais importantes:</p>
<ul>
<li><code>[1]</code> nós estamos lendo o nosso template usando o <code>PdfReader</code>, assim como mostrei já antes.</li>
<li><code>[2]</code> como nosso arquivo possui apenas uma página, podemos usar <code>.pages[0][ANNOT_KEY]</code> para pegar as <em>annotations</em> do arquivo diretamente. Caso você tenha mais de 1 página, isso ficará dentro de um outro loop.</li>
<li><code>[3]</code> vamos agora percorrer todas as <em>annotations</em> que pegamos na página.</li>
<li><code>[4]</code> verificamos se essa annotation possui algo dentro da chave <code>'/T'</code>. É lá onde teremos os nosso campos editáveis.</li>
<li><code>[5]</code> aqui nós vamos usar slice para pegar a key de <code>annotation[ANNOT_FIELD_KEY][1:-1]</code> da maneira como salvamos no nosso dicionário. Lembra da imagem que as keys dos campos editáveis são salvas da seguinte maneira: <code>[business_name]</code>? Com o slice <code>[1:-1]</code> só será retornado o texto dentro dos <code>[]</code>.</li>
<li><code>[6]</code> vamos nos assegurar que a key que pegamos está dentro do nosso dicionário de dados. Isso vai ser necessário no nosso caso porque por questões de praticidade, não editei todos os fields do template, somente aqueles que salvei em <code>data_dict</code>.</li>
<li><code>[7]</code> atualizamos o valor da chave <code>V</code> com o que temos no nosso <code>data_dict</code>. Isso sobrescreverá o valor vazio que está no template com o nosso valor.</li>
<li><code>[8]</code> atualizo o dict da annotation com o dict <code>update</code> contendo os novos valores.</li>
<li><code>[9]</code> ao final de cada loop, essa linha vai servir para fazer com que esse campo do form não seja mais editável quando você abri-lo. Agradecimentos a resposta nessa <a href="https://github.com/pmaupin/pdfrw/issues/186#issuecomment-585020314">issue</a></li>
<li><code>[10]</code> isso vai fazer com que quando salvarmos o arquivo, o PDF abra e não apareça mais como sendo um template sem valores nos seus campos. Sem isso, ao abrir o PDF depois de salvo, ainda mostrava os fields e só mostrava os valores ao clicar. Nessa <a href="https://github.com/pmaupin/pdfrw/issues/84#issuecomment-463493521">issue</a> encontrei isso como solução.</li>
<li><code>[11]</code> ao final de tudo, uso o <code>PdfWriter</code> para escrever o template modificado em um novo PDF.</li>
</ul>
<h1>Depois de uma longa jornada, concluímos nosso objetivo</h1>
<p>Agora temos por completo o código que vai preencher o formulário em um PDF. As aplicações disso são várias, como por exemplo: uma view Django que gera um PDF preenchido com as informações que estejam no banco de dados.</p>
<p>Isso vai diminuir a possibilidade de erro humano, além de acelerar um processo que pode ser facilmente feito pelo sistema. Agora nossos usuários podem focar em somente checar as informações (o que é muito mais rápido) e seguir com o processo.</p>
<p>O código completo você pode encontrar aqui nesse <a href="https://gist.github.com/mazulo/30b8778166897e2722d5ec4bd81f9f2e">gist</a></p>
<p>Notas finais:</p>
<ul>
<li>Caso você não queira passar por toda aquela dor de cabeça em achar um jeito de editar os nomes dos campos, fiz esse <a href="https://gist.github.com/mazulo/1ffa79d611d096771dd602ef680a9ac7">script</a> que vai mostrar pra você o nome deles. Com isso, você pode ir testando eles e usá-los como keys no seu dicionário de dados.</li>
<li>Tive alguns problemas na edição usando <em>Master PDF Editr</em> e <em>PDF Escape</em> online. O script não estava conseguindo atualizar os dados em alguns dos campos. Então caso queira testar esse código com um template que funcione por completo, estou deixando nesse <a href="https://bostata.com/download/post/fillable_pdf/invoice_template.pdf">link</a> o PDF que o autor do post usou como exemplo. Esse foi editado usando o Adobe Acrobat PDF. Infelizmente não temos opções muito poderosas assim para linux (não que eu conheça, ainda estou pesquisando para futuramente atualizar o post mas caso você conheça, deixa lá nos comentários :)</li>
<li>Apesar de ser consideravelmente simples usar <a href="https://github.com/pmaupin/pdfrw">pdfrw</a>, a lib não tem atualizações desde 2018 e a última interação do criador em PRs foi em junho de 2019. As outras libs listadas naqueles 2 artigos também não estão em um estado muito diferente :/</li>
</ul>
<p>Dúvidas e/ou críticas, só visitar os comentários mais abaixo. Valeu pessoal, e até a próxima!</p>
            <div class="hr"></div>
            <a href="#" class="go-top">Ir para o topo</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "dunderlabs"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div><footer class="footer">
    <p>&copy; __labs__ &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        try {
            var pageTracker = _gat._getTracker("UA-72641866-1");
            pageTracker._trackPageview();
            } catch(err) {}
    </script>
</body>
</html>